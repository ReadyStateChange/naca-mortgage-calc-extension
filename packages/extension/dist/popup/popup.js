class I{constructor(){this.calcMethod="payment"}setCalcMethod(G){this.calcMethod=G}formatNumber(G,K=2,z="$"){if(isNaN(G))return"";return`${z}${G.toFixed(K).replace(/\B(?=(\d{3})+(?!\d))/g,",")}`}calculateBaseMonthlyPayment(G,K,z){let Q=K/100/12,$=z*12;return G*Q*Math.pow(1+Q,$)/(Math.pow(1+Q,$)-1)}calculateMonthlyTax(G,K){let z=K/1000,$=G*z/12;return Math.round($)}calculateMaxPurchasePrice(G,K,z,Q,$,Z,Y=0){let _=K/100/12,U=z*12,X=G*U,H=0,L=X*2,N=0,R=1000,V=0,k=0;while(N<R&&Math.abs(V-G)>0.01){k=(H+L)/2;let C=k-Y>0?k-Y:0;if(V=this.calculateBaseMonthlyPayment(C,K,z)+this.calculateMonthlyTax(k,Q)+$+Z,V>G)L=k;else H=k;N++}return k}calculateInterestRateBuydown(G,K,z,Q){if(isNaN(G)||isNaN(K)||isNaN(z)||isNaN(Q)||G<=0||Q<=0)return 0;let Z=K-1.5,Y=Math.max(z,Z),_=K-Y;if(_<=0)return 0;let U;if(Q===15)U=4;else U=6;return _*U*G/100}calculate(G){let{price:K,term:z,rate:Q,tax:$,insurance:Z,hoaFee:Y,principalBuydown:_=0}=G;if(this.calcMethod==="payment"){let U=K,X=this.calculateMaxPurchasePrice(U,Q,z,$,Z,Y,_),H=X-_,L=this.calculateBaseMonthlyPayment(H>0?H:0,Q,z),N=this.calculateMonthlyTax(X,$);return{monthlyPayment:this.formatNumber(U),purchasePrice:this.formatNumber(X),principalInterest:this.formatNumber(L),taxes:this.formatNumber(N),insuranceAmount:this.formatNumber(Z),hoaFee:this.formatNumber(Y)}}else{let U=K,X=U-_,H=this.calculateBaseMonthlyPayment(X>0?X:0,Q,z),L=this.calculateMonthlyTax(U,$),N=H+L+Z+Y;return{monthlyPayment:this.formatNumber(N),purchasePrice:this.formatNumber(U),principalInterest:this.formatNumber(H),taxes:this.formatNumber(L),insuranceAmount:this.formatNumber(Z),hoaFee:this.formatNumber(Y)}}}calculateRaw(G){let{price:K,term:z,rate:Q,tax:$,insurance:Z,hoaFee:Y,principalBuydown:_=0}=G;if(this.calcMethod==="payment"){let U=K,X=this.calculateMaxPurchasePrice(U,Q,z,$,Z,Y,_),H=X-_,L=this.calculateBaseMonthlyPayment(H>0?H:0,Q,z),N=this.calculateMonthlyTax(X,$);return{monthlyPayment:U,purchasePrice:X,principalInterest:L,taxes:N,insurance:Z,hoaFee:Y}}else{let U=K,X=U-_,H=this.calculateBaseMonthlyPayment(X>0?X:0,Q,z),L=this.calculateMonthlyTax(U,$);return{monthlyPayment:H+L+Z+Y,purchasePrice:U,principalInterest:H,taxes:L,insurance:Z,hoaFee:Y}}}}function $z(G){let K=String(G).trim();if(K==="")return{ok:!1,errors:[{field:"price",message:"Required"}]};let z=parseFloat(K);if(isNaN(z))return{ok:!1,errors:[{field:"price",message:"Must be a number"}]};if(z<0)return{ok:!1,errors:[{field:"price",message:"Must be positive"}]};return{ok:!0,data:z}}var qz=[15,20,30];function Uz(G,K){let z=[],Q=parseInt(G,10);if(isNaN(Q)||!qz.includes(Q))return z.push({field:"term",message:"Invalid term. Must be 15, 20, or 30"}),{ok:!1,errors:z};let $=parseFloat(K);if(isNaN($))return z.push({field:"rate",message:"Rate must be a number"}),{ok:!1,errors:z};if($<=0)return z.push({field:"rate",message:"Rate must be positive"}),{ok:!1,errors:z};return{ok:!0,data:{term:Q,rate:$}}}var e=[];for(let G=5;G<=30.5;G+=0.5)e.push(Math.round(G*10)/10);function Hz(G){let K=String(G).trim();if(K==="")return{ok:!1,errors:[{field:"tax",message:"Required"}]};let z=parseFloat(K);if(isNaN(z))return{ok:!1,errors:[{field:"tax",message:"Property tax must be a number"}]};let Q=Math.round(z*10)/10;if(!e.includes(Q))return{ok:!1,errors:[{field:"tax",message:"Invalid property tax rate"}]};return{ok:!0,data:z}}function o(G,K){let z=parseFloat(G);if(isNaN(z))return{ok:!1,errors:[{field:K,message:"Must be a number"}]};if(z<0)return{ok:!1,errors:[{field:K,message:"Must be non-negative"}]};return{ok:!0,data:z}}function zz(G){let K=[],z={},Q=$z(G.price);if(!Q.ok)K.push(...Q.errors||[]);else z.price=Q.data;let $=Uz(G.term,G.rate);if(!$.ok)K.push(...$.errors||[]);else z.term=$.data.term,z.rate=$.data.rate;if(G.tax===void 0||G.tax===null)K.push({field:"tax",message:"Required"});else{let Z=Hz(String(G.tax));if(!Z.ok)K.push(...Z.errors||[]);else z.tax=Z.data}if(G.insurance===void 0||G.insurance===null)K.push({field:"insurance",message:"Required"});else{let Z=o(String(G.insurance),"insurance");if(!Z.ok)K.push(...Z.errors||[]);else z.insurance=Z.data}if(G.hoaFee===void 0||G.hoaFee===null)K.push({field:"hoaFee",message:"Required"});else{let Z=o(String(G.hoaFee),"hoaFee");if(!Z.ok)K.push(...Z.errors||[]);else z.hoaFee=Z.data}if(G.principalBuydown===void 0||G.principalBuydown===null)K.push({field:"principalBuydown",message:"Required"});else{let Z=o(String(G.principalBuydown),"principalBuydown");if(!Z.ok)K.push(...Z.errors||[]);else z.principalBuydown=Z.data}if(K.length>0)return{ok:!1,errors:K};return{ok:!0,data:z}}function Gz(G,K){let z=zz(G);if(!z.ok)return{ok:!1,errors:z.errors||[]};let Q=new I;return Q.setCalcMethod(K),{ok:!0,data:Q.calculateRaw(z.data)}}function h(G,K){let z=new I;return z.setCalcMethod(K),z.calculateRaw(G)}function O(G,K=2){if(isNaN(G))return"";return"$"+G.toFixed(K).replace(/\B(?=(\d{3})+(?!\d))/g,",")}function u(G,K,z,Q){return new I().calculateInterestRateBuydown(G,K,z,Q)}var kz=86400000;document.addEventListener("DOMContentLoaded",async()=>{let G=document.querySelectorAll('input[name="calcMethod"]'),K=document.getElementById("price"),z=document.getElementById("term"),Q=document.getElementById("rate"),$=document.getElementById("tax"),Z=document.getElementById("insurance"),Y=document.getElementById("hoaFee"),_=document.getElementById("downPayment"),U=document.getElementById("calculate"),X=document.getElementById("monthlyPayment"),H=document.getElementById("purchasePrice"),L=document.getElementById("principalInterest"),N=document.getElementById("taxes"),R=document.getElementById("insuranceAmount"),V=document.getElementById("hoaFeeDisplay"),k=document.getElementById("interestRateBuydown"),C=document.getElementById("interestRateBuydownValue"),F=document.getElementById("principalBuydown"),Kz=document.getElementById("principalBuydownValue"),b=document.getElementById("interestRateBuydownCost"),c=document.getElementById("principalBuydownCost"),v=document.getElementById("button-errors"),f=!1,A=null,T="payment";function Qz(J){if(s(),J.forEach((W)=>{let q=document.getElementById(`${W.field}-error`);if(q)q.textContent=W.message,q.classList.add("visible"),q.closest(".input-group")?.classList.add("has-error")}),J.length>0){U.classList.add("has-error");let W={price:"Price/Payment",term:"Loan Term",rate:"Interest Rate",tax:"Property Tax",insurance:"Insurance",hoaFee:"HOA/Condo Fee",principalBuydown:"Principal Buydown"},q=J.map((j)=>`<li>${W[j.field]||j.field}: ${j.message}</li>`).join("");v.innerHTML=`<ul>${q}</ul>`,v.classList.add("visible")}}function s(){document.querySelectorAll(".error-message").forEach((J)=>{J.textContent="",J.classList.remove("visible")}),document.querySelectorAll(".input-group.has-error").forEach((J)=>{J.classList.remove("has-error")}),U.classList.remove("has-error"),v.innerHTML="",v.classList.remove("visible")}function S(J){let W=document.getElementById(`${J}-error`);if(W)W.textContent="",W.classList.remove("visible"),W.closest(".input-group")?.classList.remove("has-error");U.classList.remove("has-error"),v.innerHTML="",v.classList.remove("visible")}function Wz(){K.addEventListener("input",()=>S("price")),z.addEventListener("change",()=>S("term")),Q.addEventListener("change",()=>S("rate")),$.addEventListener("change",()=>S("tax")),Z.addEventListener("input",()=>S("insurance")),Y.addEventListener("input",()=>S("hoaFee"))}Wz();function E(J){X.textContent=O(J.monthlyPayment),H.textContent=O(J.purchasePrice),L.textContent=O(J.principalInterest),N.textContent=O(J.taxes),R.textContent=O(J.insurance),V.textContent=O(J.hoaFee),M()}function M(){let J=H.textContent?.replace(/[$,]/g,"")||"0",W=parseFloat(J)||0;if(F.max=W>0?String(W):"0",parseFloat(F.value)>W)F.value=String(W),F.dispatchEvent(new Event("input"))}function jz(J){X.textContent=J.monthlyPayment,H.textContent=J.purchasePrice,L.textContent=J.principalInterest,N.textContent=J.taxes,R.textContent=J.insuranceAmount,V.textContent=J.hoaFee,M()}let i=await Yz();function l(J){Q.innerHTML="";let W=i[J]||i["30"];if(W.forEach((q)=>{let j=document.createElement("option");j.value=String(q),j.textContent=`${q}%`,Q.appendChild(j)}),W.length>1)Q.value=String(W[1]);setTimeout(()=>{let q=parseFloat(Q.value);k.max=String(q);let j=Math.max(0,q-1.5);k.min=String(j),k.step="0.001",k.value=String(q),C.textContent=`${q}%`,b.textContent="$0"},0)}$.value="15.00",Z.value="50",Y.value="0",_.value="0",l(z.value),z.addEventListener("change",()=>{l(z.value),b.textContent="$0",c.textContent="$0",setTimeout(()=>{if(f&&A){let J={...A,term:parseInt(z.value)||30,rate:parseFloat(k.value)||0},W=h(J,T);E(W)}},50)}),Q.addEventListener("change",()=>{let J=parseFloat(Q.value);if(k.max=String(J),k.min=String(Math.max(0,J-1.5)),k.step="0.001",k.value=String(J),C.textContent=`${J}%`,b.textContent="$0",c.textContent="$0",f&&A){let W={...A,rate:J},q=h(W,T);E(q)}}),G.forEach((J)=>{J.addEventListener("change",(W)=>{T=W.target.value,K.placeholder=T==="payment"?"Enter desired monthly payment":"Enter purchase price",f=!1,A=null,M()})}),U.addEventListener("click",()=>{let J={price:K.value,term:z.value,rate:k.value,tax:$.value,insurance:Z.value,hoaFee:Y.value,principalBuydown:F.value},W=Gz(J,T);if(!W.ok){Qz(W.errors);return}s(),f=!0,A={price:W.data.purchasePrice,term:parseInt(z.value),rate:parseFloat(k.value),tax:parseFloat($.value),insurance:parseFloat(Z.value),hoaFee:parseFloat(Y.value),principalBuydown:parseFloat(F.value)},E(W.data)}),k.addEventListener("input",()=>{let J=parseFloat(k.value),W=parseFloat(Q.value),q=parseInt(z.value),j=H.textContent?.replace(/[$,]/g,"")||"0",g=parseFloat(j)||0;if(g>0){let p=u(g,W,J,q);b.textContent=O(p);let P=Math.max(0,W-1.5),B=!1;if(J<P)J=P,k.value=String(P),B=!0;if(C.textContent=B?`${J.toFixed(3)}% (1.5% cap reached)`:`${J.toFixed(3)}%`,f&&A){let D={...A,rate:J},a=h(D,T);if(T==="price")E(a),H.textContent=O(D.price);else E(a),X.textContent=O(D.price);M()}}}),F.addEventListener("input",()=>{let J=parseFloat(F.value)||0;if(Kz.textContent=O(J),c.textContent=O(J),f&&A){let W=parseFloat(k.value),q=parseInt(z.value),j={...A,principalBuydown:J},g=h(j,T);if(T==="price")E(g),H.textContent=O(j.price);else E(g),X.textContent=O(j.price);M();let p=parseFloat(Q.value),P=H.textContent?.replace(/[$,]/g,"")||"0",B=parseFloat(P)||0;if(B>0){let D=u(B,p,W,q);b.textContent=O(D)}else b.textContent="$0"}}),[K,Q,$,Z,Y].forEach((J)=>{J.addEventListener("input",(W)=>{let q=W.target.value.replace(/[^0-9.]/g,""),j=q.split(".");if(j.length>2)q=j[0]+"."+j.slice(1).join("");W.target.value=q})});let n=document.querySelectorAll(".tab-btn"),Zz=document.querySelectorAll(".tab-content");n.forEach((J)=>{J.addEventListener("click",()=>{n.forEach((q)=>q.classList.remove("active")),Zz.forEach((q)=>q.classList.remove("active")),J.classList.add("active");let W=J.getAttribute("data-tab");if(W)document.getElementById(W)?.classList.add("active")})});let r=document.getElementById("address"),t=document.getElementById("lookup-btn"),x=document.getElementById("msaStatus"),w=document.getElementById("msaResultMsaIncome"),m=document.getElementById("msaResultTractIncome"),y=document.getElementById("msaResultTractPercent"),d=document.getElementById("msaResultYear");if(t&&r&&x)t.addEventListener("click",()=>{let J=r.value.trim();if(!J){x.textContent="Please enter an address.";return}if(x.textContent="Looking up address...",w)w.textContent="-";if(m)m.textContent="-";if(y)y.textContent="-";if(d)d.textContent="-";Xz(J).then((W)=>{if(W){if(x.textContent=`Data found for: ${W.address||J}`,w)w.textContent=`$${W.msaMedianFamilyIncome?.toLocaleString()||"N/A"}`;if(m)m.textContent=`$${W.tractMedianFamilyIncome?.toLocaleString()||"N/A"}`;if(y)y.textContent=`${W.tractPercentOfMsa||"N/A"}%`;if(d)d.textContent=String(W.year||"N/A")}else x.textContent="Could not retrieve data for this address."}).catch((W)=>{x.textContent=`Error: ${W.message}`,console.error("MSA lookup error:",W)})})});async function Xz(G){try{let z=await fetch("https://naca-mortgage-calc-extension-production.up.railway.app/api/msa-lookup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({address:G})});if(!z.ok){let $=await z.json();throw Error($.error||`HTTP error! status: ${z.status}`)}return await z.json()}catch(z){throw console.error("API call failed:",z),Error("Failed to fetch income data from the server.")}}async function Yz(){let K=localStorage.getItem("nacaMortgageRates");if(K)try{let{rates:z,timestamp:Q}=JSON.parse(K);if(Date.now()-Q<kz)return console.log("Using cached mortgage rates"),z}catch(z){console.warn("Failed to parse cached rates:",z),localStorage.removeItem("nacaMortgageRates")}console.log("Fetching fresh mortgage rates from Railway API");try{let z=await fetch("https://naca-mortgage-calc-extension-production.up.railway.app/api/rates",{method:"GET",headers:{"Content-Type":"application/json"}});if(!z.ok){let Z=await z.json();throw Error(Z.error||`HTTP error! status: ${z.status}`)}let Q=await z.json();if(!Q)return console.warn("No mortgage rate data received from the API."),Jz();let $={"15":[parseFloat(Q.fifteen_year_rate),parseFloat(Q.fifteen_year_rate)+1],"20":[parseFloat(Q.twenty_year_rate),parseFloat(Q.twenty_year_rate)+1],"30":[parseFloat(Q.thirty_year_rate),parseFloat(Q.thirty_year_rate)+1]};try{localStorage.setItem("nacaMortgageRates",JSON.stringify({rates:$,timestamp:Date.now()})),console.log("Mortgage rates cached successfully")}catch(Z){console.warn("Failed to cache rates:",Z)}return $}catch(z){return console.error("Failed to fetch latest mortgage rates:",z),console.warn("Returning default rates due to fetch error."),Jz()}}function Jz(){return{"15":[5,6],"20":[5.5,6.5],"30":[6,7]}}
